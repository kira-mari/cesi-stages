<?php
namespace Controllers;

use Core\Controller;
use Core\Mailer;
use Models\User;

/**
 * Contrôleur d'authentification
 */
class Auth extends Controller
{
    /**
     * Page de connexion
     *
     * @return void
     */
    public function login()
    {
        // Si déjà connecté, rediriger vers le tableau de bord
        if ($this->isAuthenticated()) {
            $this->redirect('dashboard');
        }

        $errors = [];

        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $email = filter_input(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL);
            $password = $_POST['password'] ?? '';

            if (empty($email) || empty($password)) {
                $errors[] = "Veuillez remplir tous les champs.";
            } else {
                $userModel = new User();
                $user = $userModel->findByEmail($email);

                if ($user && password_verify($password, $user['password'])) {
                    // Connexion réussie
                    $_SESSION['user_id'] = $user['id'];
                    $_SESSION['user_email'] = $user['email'];
                    $_SESSION['user_role'] = $user['role'];
                    $_SESSION['user_nom'] = $user['nom'];
                    $_SESSION['user_prenom'] = $user['prenom'];

                    // Régénération de l'ID de session pour la sécurité
                    session_regenerate_id(true);

                    $_SESSION['flash_success'] = "Connexion réussie ! Bienvenue, " . $user['prenom'] . ".";
                    $this->redirect('dashboard');
                } else {
                    $errors[] = "Email ou mot de passe incorrect.";
                }
            }
        }

        $this->render('auth/login', [
            'title' => 'Connexion - ' . APP_NAME,
            'errors' => $errors,
            'csrf_token' => $this->generateCsrfToken()
        ]);
    }

    /**
     * Démarre le flux OAuth Google (redirection vers Google)
     */
    public function googleRedirect()
    {
        if (!GOOGLE_OAUTH_ENABLED) {
            http_response_code(404);
            echo 'Google SSO non configuré.';
            exit;
        }

        $params = [
            'client_id' => GOOGLE_CLIENT_ID,
            'redirect_uri' => GOOGLE_REDIRECT,
            'response_type' => 'code',
            'scope' => 'openid email profile',
            'access_type' => 'offline',
            'prompt' => 'select_account'
        ];

        $url = 'https://accounts.google.com/o/oauth2/v2/auth?' . http_build_query($params);
        header('Location: ' . $url);
        exit;
    }

    /**
     * Callback Google OAuth: échange le code, récupère les infos utilisateur
     */
    public function googleCallback()
    {
        if (!GOOGLE_OAUTH_ENABLED) {
            http_response_code(404);
            echo 'Google SSO non configuré.';
            exit;
        }

        $code = $_GET['code'] ?? null;
        if (!$code) {
            $_SESSION['flash_error'] = 'Authentification Google annulée.';
            $this->redirect('login');
        }

        // Échange du code contre un token
        $tokenUrl = 'https://oauth2.googleapis.com/token';
        $post = http_build_query([
            'code' => $code,
            'client_id' => GOOGLE_CLIENT_ID,
            'client_secret' => GOOGLE_CLIENT_SECRET,
            'redirect_uri' => GOOGLE_REDIRECT,
            'grant_type' => 'authorization_code'
        ]);

        $opts = [
            'http' => [
                'method' => 'POST',
                'header' => "Content-type: application/x-www-form-urlencoded\r\n",
                'content' => $post,
                'timeout' => 10
            ]
        ];

        $response = @file_get_contents($tokenUrl, false, stream_context_create($opts));
        if ($response === false) {
            $_SESSION['flash_error'] = 'Erreur lors de la récupération du token Google.';
            $this->redirect('login');
        }

        $data = json_decode($response, true);
        if (empty($data['access_token'])) {
            $_SESSION['flash_error'] = 'Token Google invalide.';
            $this->redirect('login');
        }

        // Récupération des informations utilisateur
        $opts = [
            'http' => [
                'method' => 'GET',
                'header' => "Authorization: Bearer " . $data['access_token'] . "\r\n",
                'timeout' => 10
            ]
        ];

        $userInfo = @file_get_contents('https://www.googleapis.com/oauth2/v2/userinfo', false, stream_context_create($opts));
        if ($userInfo === false) {
            $_SESSION['flash_error'] = 'Impossible de récupérer les informations Google.';
            $this->redirect('login');
        }

        $u = json_decode($userInfo, true);
        $email = $u['email'] ?? null;
        $prenom = $u['given_name'] ?? ($u['name'] ?? '');
        $nom = $u['family_name'] ?? '';

        if (!$email) {
            $_SESSION['flash_error'] = 'Email Google introuvable.';
            $this->redirect('login');
        }

        $userModel = new User();
        $user = $userModel->findByEmail($email);

        if (!$user) {
            // Création d'un compte utilisateur par défaut (rôle étudiant)
            $password = bin2hex(random_bytes(8));
            $userId = $userModel->create([
                'nom' => $nom ?: 'Google',
                'prenom' => $prenom ?: 'User',
                'email' => $email,
                'password' => password_hash($password, PASSWORD_BCRYPT),
                'role' => 'etudiant'
            ]);

            if ($userId) {
                $user = $userModel->findByEmail($email);
            }
        }

        if ($user) {
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['user_email'] = $user['email'];
            $_SESSION['user_role'] = $user['role'];
            $_SESSION['user_nom'] = $user['nom'];
            $_SESSION['user_prenom'] = $user['prenom'];
            session_regenerate_id(true);
            $_SESSION['flash_success'] = "Connexion via Google réussie. Bienvenue, " . ($user['prenom'] ?? '') . ".";
            $this->redirect('dashboard');
        }

        $_SESSION['flash_error'] = 'Impossible de créer ou trouver l\'utilisateur.';
        $this->redirect('login');
    }

    /**
     * Déconnexion
     *
     * @return void
     */
    public function logout()
    {
        // Suppression de toutes les variables de session
        $_SESSION = [];

        // Destruction du cookie de session
        if (isset($_COOKIE[session_name()])) {
            setcookie(session_name(), '', [
                'expires' => time() - 3600,
                'path' => '/',
                'secure' => true,
                'httponly' => true,
                'samesite' => 'Strict'
            ]);
        }

        // Destruction de la session
        session_destroy();

        // Redirection vers la page d'accueil
        header("Location: " . BASE_URL);
        exit;
    }

    /**
     * Page d'inscription (Publique)
     *
     * @return void
     */
    public function register()
    {
        // Si déjà connecté, rediriger
        if ($this->isAuthenticated()) {
            $this->redirect('dashboard');
        }

        $errors = [];
        $success = false;

        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            // Vérification du token CSRF
            $csrfToken = $_POST['csrf_token'] ?? '';
            if (!$this->verifyCsrfToken($csrfToken)) {
                $errors[] = "Token de sécurité invalide.";
            } else {
                $nom = htmlspecialchars(trim($_POST['nom'] ?? ''));
                $prenom = htmlspecialchars(trim($_POST['prenom'] ?? ''));
                $email = filter_input(INPUT_POST, 'email', FILTER_SANITIZE_EMAIL);
                $password = $_POST['password'] ?? '';
                $confirm_password = $_POST['confirm_password'] ?? '';
                // Par défaut, l'inscription publique crée un étudiant
                $role = 'etudiant';

                // Validation
                if (empty($nom) || empty($prenom) || empty($email) || empty($password)) {
                    $errors[] = "Veuillez remplir tous les champs obligatoires.";
                }

                if ($password !== $confirm_password) {
                    $errors[] = "Les mots de passe ne correspondent pas.";
                }

                if (strlen($password) < 8) {
                    $errors[] = "Le mot de passe doit contenir au moins 8 caractères.";
                }

                if (empty($errors)) {
                    $userModel = new User();

                    // Vérification si l'email existe déjà
                    if ($userModel->findByEmail($email)) {
                        $errors[] = "Cet email est déjà utilisé.";
                    } else {
                        // Génération d'un code de validation
                        $validationCode = Mailer::generateValidationCode();
                        
                        // Création de l'utilisateur
                        $userId = $userModel->create([
                            'nom' => $nom,
                            'prenom' => $prenom,
                            'email' => $email,
                            'password' => password_hash($password, PASSWORD_BCRYPT),
                            'role' => $role,
                            'validation_code' => $validationCode,
                            'validation_expires_at' => date('Y-m-d H:i:s', strtotime('+30 minutes')),
                            'email_verified' => false
                        ]);

                        if ($userId) {
                            // Envoi du mail de validation
                            if (Mailer::sendValidationEmail($email, $prenom, $validationCode)) {
                                // Redirection vers la page de validation
                                $_SESSION['user_to_validate'] = [
                                    'id' => $userId,
                                    'email' => $email,
                                    'prenom' => $prenom
                                ];
                                $this->redirect('validate-email');
                            } else {
                                // Le compte a été créé mais l'email ne s'est pas envoyé
                                $errors[] = "Compte créé mais impossible d'envoyer l'email de validation. Vérifiez votre configuration mail.";
                            }
                        } else {
                            $errors[] = "Une erreur s'est produite lors de la création de l'utilisateur.";
                        }
                    }
                }
            }
        }

        $this->render('auth/register', [
            'title' => 'Créer un compte - ' . APP_NAME,
            'errors' => $errors,
            'success' => $success,
            'csrf_token' => $this->generateCsrfToken()
        ]);
    }

    /**
     * Page de validation d'email
     *
     * @return void
     */
    public function validateEmail()
    {
        // Vérifier que l'utilisateur est en train de s'inscrire
        if (empty($_SESSION['user_to_validate'])) {
            $_SESSION['flash_error'] = "Aucune validation en cours.";
            $this->redirect('login');
        }

        $errors = [];
        $userToValidate = $_SESSION['user_to_validate'];

        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $csrfToken = $_POST['csrf_token'] ?? '';
            if (!$this->verifyCsrfToken($csrfToken)) {
                $errors[] = "Token de sécurité invalide.";
            } else {
                $code = htmlspecialchars(trim($_POST['code'] ?? ''));

                if (empty($code) || strlen($code) !== 6 || !ctype_digit($code)) {
                    $errors[] = "Veuillez entrer un code à 6 chiffres valide.";
                } else {
                    $userModel = new User();
                    $user = $userModel->find($userToValidate['id']);

                    if (!$user) {
                        $errors[] = "Utilisateur introuvable.";
                    } elseif ($user['email_verified']) {
                        $_SESSION['flash_info'] = "Email déjà vérifié. Connectez-vous.";
                        unset($_SESSION['user_to_validate']);
                        $this->redirect('login');
                    } else {
                        // Vérifier expiration du code
                        if (strtotime($user['validation_expires_at']) < time()) {
                            $errors[] = "Le code de validation a expiré. Inscrivez-vous à nouveau.";
                        } elseif ($user['validation_code'] !== $code) {
                            // Incrémenter les tentatives
                            $user['validation_attempts'] = ($user['validation_attempts'] ?? 0) + 1;
                            
                            if ($user['validation_attempts'] >= 3) {
                                $errors[] = "Trop de tentatives. Inscrivez-vous à nouveau.";
                                // Supprimer l'utilisateur après 3 tentatives
                                $userModel->delete($user['id']);
                                unset($_SESSION['user_to_validate']);
                            } else {
                                $errors[] = "Code incorrect. (" . (3 - $user['validation_attempts']) . " tentatives restantes)";
                                $userModel->update($user['id'], ['validation_attempts' => $user['validation_attempts']]);
                            }
                        } else {
                            // Code correct : marquer l'email comme vérifié
                            $userModel->update($user['id'], [
                                'email_verified' => true,
                                'validation_code' => null,
                                'validation_expires_at' => null,
                                'validation_attempts' => 0
                            ]);

                            unset($_SESSION['user_to_validate']);
                            $_SESSION['flash_success'] = "Email vérifié avec succès ! Vous pouvez maintenant vous connecter.";
                            $this->redirect('login');
                        }
                    }
                }
            }
        }

        $this->render('auth/validate-email', [
            'title' => 'Vérifier votre email - ' . APP_NAME,
            'errors' => $errors,
            'email' => $userToValidate['email'] ?? '',
            'prenom' => $userToValidate['prenom'] ?? '',
            'csrf_token' => $this->generateCsrfToken()
        ]);
    }

    /**
     * Renvoyer le code de validation
     *
     * @return void
     */
    public function resendValidationCode()
    {
        if (empty($_SESSION['user_to_validate'])) {
            $_SESSION['flash_error'] = "Aucune validation en cours.";
            $this->redirect('login');
        }

        $userToValidate = $_SESSION['user_to_validate'];
        $userModel = new User();
        $user = $userModel->find($userToValidate['id']);

        if ($user && !$user['email_verified']) {
            // Générer un nouveau code
            $validationCode = Mailer::generateValidationCode();
            
            $userModel->update($user['id'], [
                'validation_code' => $validationCode,
                'validation_expires_at' => date('Y-m-d H:i:s', strtotime('+30 minutes')),
                'validation_attempts' => 0
            ]);

            // Envoyer le nouvel email
            if (Mailer::sendValidationEmail($user['email'], $user['prenom'], $validationCode)) {
                $_SESSION['flash_success'] = "Un nouveau code a été envoyé à votre email.";
            } else {
                $_SESSION['flash_error'] = "Impossible d'envoyer le code. Vérifiez votre configuration mail.";
            }
        }

        $this->redirect('validate-email');
    }
}
